Include: AwaitTimeout.vader
Include: SubscriptionHelpers.vader

Execute (Pipeline: Setup Model, ThreadsBuffer; Subscribe; Initialize Mock Debug Adapter):
  " subscribe to all incoming messages
  call g:dapper_middletalker.subscribe('.*', function('StoreMessage'))
  let g:model = dapper#model#Model#new(g:dapper_middletalker)

  " setup ThreadsBuffer, which should (itself) subscribe
  if exists('g:tb') | unlet g:tb | endif
  let g:tb = dapper#view#ThreadsBuffer#new(g:model, g:dapper_middletalker)

  " start mock debug adapter
  let g:start_args = dapper#config#DapperConfig#new(
      \ g:dapper_filetypes_to_configs['markdown']['mock'],
      \ {})
  call DapperStart(g:start_args)
  call AwaitTimeout({ -> ReceivedMessage('InitializedEvent')}, 3000, v:true)

Execute (Pipeline: Launch Debuggee):
  let g:launch_args = dapper#dap#LaunchRequestArguments#new()
  let g:launch_args['program'] = g:project_root.'/test/TEST_README.md'
  call DapperRequest('launch', 0, g:launch_args)
  call AwaitTimeout({ -> ReceivedMessage('LaunchResponse')}, 4000, v:true)

Execute (Pipeline: Request Threads):
  call g:model.update()
  call g:tb.open()
  call AwaitTimeout({ -> ReceivedMessage('ThreadsResponse')}, 3000, v:true)
Expect:
  <threads>
  thread id: 1	name: thread 1		status: (N/A)
  </threads>

Execute (Pipeline: Create A Free, Unattached StackTraceBuffer):
  let g:stb = dapper#view#StackTraceBuffer#new(g:dapper_middletalker)
Execute (Pipeline: Dig Down into StackTraceBuffer):
  call g:tb.open()
  normal! gg
  execute "normal \<cr>"
Expect:
  <stacktrace>
  (0)	[NO]	(l:8, c:0)	The(0)
  (1)	[NO]	(l:8, c:0)	word(1)
  (2)	[NO]	(l:8, c:0)	`exception`(2)
  (3)	[NO]	(l:8, c:0)	causes(3)
  (4)	[NO]	(l:8, c:0)	the(4)
  (5)	[NO]	(l:8, c:0)	mock(5)
  (6)	[NO]	(l:8, c:0)	debugger(6)
  (7)	[NO]	(l:8, c:0)	to(7)
  (8)	[NO]	(l:8, c:0)	stop,(8)
  (9)	[NO]	(l:8, c:0)	due(9)
  (10)	[NO]	(l:8, c:0)	to(10)
  (11)	[NO]	(l:8, c:0)	an(11)
  (12)	[NO]	(l:8, c:0)	"exception".(12)
  </stacktrace>

Execute(Pipeline: Check That Only the Child StackTraceBuffer Was Modified):
  AssertEqual 0, len(g:stb.getLines(0, -1))

Execute (Pipeline: Cleanup):
  call g:tb.open()
  normal!ggVGd
  unlet g:tb
